<html>
  <head>
    <title>Request a ride - Ride App</title>
    <link rel="icon" type="image/jpg" href="rideapp-icon.jpg" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/1.1.2/tailwind.min.css" integrity="sha256-bCQF5OufWlWM/MW9mCb/eDibvff1W8BNq9ZK69C8FSI=" crossorigin="anonymous" />
  </head>
  <body>
    <div class="w-full h-full flex justify-center items-center">
      <div class="w-3/12 max-w-xs">
        <div class="text-center">
          <img src="rideapp-icon.jpg" alt="Logo" class="w-1/2 inline-block">
        </div>
        <form id="requestForm" class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
          <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2" for="username">
              Slack Username
            </label>
            <input
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              id="username" type="text" placeholder="Slack Username" required>
          </div>
          <div class="flex items-center justify-between">
            <button id="submit" class="w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
              Request a ride
            </button>
            <div id="assigned-response-block" class="hidden">
              <div class="bg-teal-100 border-t-4 border-teal-500 rounded-b text-teal-900 px-4 py-3 shadow-md" role="alert">
                <div>
                  <p class="font-bold">Awesome!</p>
                  <p class="text-sm" id="assigned-response"></p>
                </div>
              </div>
            </div>
          </div>
        </form>
        <p class="text-center text-gray-500 text-xs">
          &copy;2019 Ride App. All rights reserved.
        </p>
      </div>
    </div>

    <style>
    #submit:disabled {
      opacity: .6;
    }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <script>
      const socket = io('http://localhost:3000/', { path: '/ws' });
      const submit = document.getElementById('submit');
      const assignedResponse = document.getElementById('assigned-response');
      const assignedResponseBlock = document.getElementById('assigned-response-block');
      let username;

      document.getElementById('requestForm').addEventListener('submit', function (ev) {
        ev.preventDefault();
        username = document.getElementById('username').value;
        submit.setAttribute('disabled', 'disabled');
        submit.innerText = 'Please, wait while we find you a driver...';

        socket.emit('ride__requested', {
          user: {
            id: username,
          },
          ride: {
            id: Date.now(),
            from: {
              latitude: 2,
              longitude: 1,
            },
            to: {
              latitude: 3,
              longitude: 1,
            },
            price: 30
          }
        });
        socket.on('ride__assigned', (event) => {
          try {
            const ev = JSON.parse(event);
            submit.classList.add('hidden');
            assignedResponse.innerText = `Your ride has been accepted. ${ev.driver.fullName} will arrive in a few minutes.`;
            assignedResponseBlock.classList.remove('hidden');
          } catch (e) {
            console.error(e);
          }
        });
      });
    </script>
  </body>
</html>
